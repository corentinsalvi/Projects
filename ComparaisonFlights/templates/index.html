<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche de Vols</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>‚úàÔ∏è Recherche de Vols</h1>

        <div class="search-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="departure_airport">A√©roport de d√©part (code IATA)</label>
                    <input type="text" id="departure_airport" placeholder="Ex: CDG" maxlength="3" required>
                </div>
                <div class="form-group">
                    <label for="arrival_airport">A√©roport d'arriv√©e (code IATA)</label>
                    <input type="text" id="arrival_airport" placeholder="Ex: DXB" maxlength="3" required>
                </div>
                <div class="form-group">
                    <label for="departure_date">Date de d√©part</label>
                    <input type="date" id="departure_date" required>
                </div>
                <div class="form-group">
                    <label for="return_date">Date de retour</label>
                    <input type="date" id="return_date" required>
                </div>
                <button onclick="searchFlights()" id="searchBtn">
                    <i class="fa fa-search"></i> Rechercher les Vols
                </button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Recherche en cours...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="results" class="results"></div>
    </div>

    <script>
        async function searchFlights() {
            const departure = document.getElementById('departure_airport').value.toUpperCase();
            const arrival = document.getElementById('arrival_airport').value.toUpperCase();
            const departureDate = document.getElementById('departure_date').value;
            const returnDate = document.getElementById('return_date').value;

            if (!departure || !arrival || !departureDate || !returnDate) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const error = document.getElementById('error');
            const searchBtn = document.getElementById('searchBtn');

            loading.style.display = 'block';
            results.innerHTML = '';
            error.style.display = 'none';
            searchBtn.disabled = true;

            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        departure_airport: departure,
                        arrival_airport: arrival,
                        departure_date: departureDate,
                        return_date: returnDate
                    })
                });

                const data = await response.json();

                if (data.best_flights) {
                    displayResults(data);
                } else {
                    error.textContent = `Erreur: ${data.error || 'Erreur lors de la recherche'}`;
                    error.style.display = 'block';
                }
            } catch (err) {
                error.textContent = `Erreur de connexion: ${err.message}`;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                searchBtn.disabled = false;
            }
        }

        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }

        function formatFlightSegment(flight) {
            const depTime = new Date(flight.departure_airport.time);
            const arrTime = new Date(flight.arrival_airport.time);
            const depTimeStr = depTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            const arrTimeStr = arrTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            return `
                <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                    <div class="flight-info" style="margin-bottom: 10px;">
                        <div>
                            <div class="time">${depTimeStr}</div>
                            <div class="airport"><strong>${flight.departure_airport.id}</strong></div>
                            <div style="font-size: 12px; color: #999;">${flight.departure_airport.name}</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="duration">${formatDuration(flight.duration)}</div>
                            <div style="font-size: 12px; margin-top: 5px;">
                                ${flight.airplane || 'Avion'}
                            </div>
                        </div>
                        <div>
                            <div class="time">${arrTimeStr}</div>
                            <div class="airport"><strong>${flight.arrival_airport.id}</strong></div>
                            <div style="font-size: 12px; color: #999;">${flight.arrival_airport.name}</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 13px;">
                        <div>
                            <strong>${flight.airline}</strong><br>
                            <span style="color: #666;">Vol ${flight.flight_number}</span>
                        </div>
                        <div style="text-align: right;">
                            <span style="color: #667eea; font-weight: 600;">${flight.travel_class || 'Economy'}</span>
                            <br>
                            <span style="color: #999;">${flight.legroom || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        async function selectOutboundFlight(flight, departureAirport, arrivalAirport, returnDate, departureDate) {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const error = document.getElementById('error');

            loading.style.display = 'block';
            error.style.display = 'none';

            try {
                const response = await fetch('/search-return', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        departure_airport: departureAirport,
                        arrival_airport: arrivalAirport,
                        departure_date: departureDate,
                        return_date: returnDate,
                        departure_token: flight.departure_token
                    })
                });

                const data = await response.json();

                if (data.best_flights || data.other_flights) {
                    displayReturnFlights(flight, data, departureAirport, arrivalAirport);
                } else {
                    error.textContent = `Erreur: ${data.error || 'Erreur lors de la recherche'}`;
                    error.style.display = 'block';
                }
            } catch (err) {
                error.textContent = `Erreur de connexion: ${err.message}`;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayReturnFlights(outboundFlight, data, departureAirport, arrivalAirport) {
            const results = document.getElementById('results');
            const returnFlights = data.best_flights || data.other_flights || [];
            
            if (returnFlights.length === 0) {
                results.innerHTML = '<div class="no-results">Aucun vol retour trouv√©</div>';
                return;
            }

            let html = `
                <div style="margin-bottom: 30px;">
                    <h2 style="color: white; margin-bottom: 20px;">‚úàÔ∏è Vol Aller S√©lectionn√©</h2>
                    <div class="flight-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div class="price-badge">${outboundFlight.price} EUR</div>
                            <div style="text-align: right; font-size: 13px;">
                                <div style="color: #999;">Dur√©e totale</div>
                                <div style="font-weight: 600; color: #333;">${formatDuration(outboundFlight.total_duration)}</div>
                            </div>
                        </div>
                        <div class="flight-section">
                            <div class="section-title">üõ´ Vol Aller</div>
            `;
            
            const outboundSegments = outboundFlight.flights || [];
            outboundSegments.forEach((segment, index) => {
                html += formatFlightSegment(segment);
                
                if (index < outboundSegments.length - 1 && outboundFlight.layovers && outboundFlight.layovers[index]) {
                    const layover = outboundFlight.layovers[index];
                    html += `
                        <div style="padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; margin: 10px 0; border-radius: 3px;">
                            <strong>‚è±Ô∏è Escale √† ${layover.name} (${layover.id})</strong><br>
                            <span style="color: #666;">Dur√©e: ${formatDuration(layover.duration)}</span>
                        </div>
                    `;
                }
            });

            html += `
                        </div>
                    </div>
                </div>

                <h2 style="color: white; margin-bottom: 20px;">üõ¨ Vols Retour Disponibles</h2>
                <div class="results">
            `;
            
            returnFlights.forEach(returnFlight => {
                const totalPrice = outboundFlight.price + returnFlight.price;
                const returnSegments = returnFlight.flights || [];
                let returnSegmentsHtml = '';
                let returnLayoversHtml = '';
                
                returnSegments.forEach((segment, index) => {
                    returnSegmentsHtml += formatFlightSegment(segment);
                    
                    if (index < returnSegments.length - 1 && returnFlight.layovers && returnFlight.layovers[index]) {
                        const layover = returnFlight.layovers[index];
                        returnLayoversHtml += `
                            <div style="padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; margin: 10px 0; border-radius: 3px;">
                                <strong> Escale √† ${layover.name} (${layover.id})</strong><br>
                                <span style="color: #666;">Dur√©e: ${formatDuration(layover.duration)}</span>
                            </div>
                        `;
                    }
                });
                
                html += `
                    <div class="flight-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 12px; color: #999; margin-bottom: 5px;">Prix retour</div>
                                <div class="price-badge">${returnFlight.price} EUR</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #e8f0fe; border-radius: 5px;">
                                <div style="font-size: 12px; color: #667eea;">Prix total A/R</div>
                                <div style="font-weight: 600; color: #667eea; font-size: 20px;">${totalPrice} EUR</div>
                            </div>
                            <div style="text-align: right; font-size: 13px;">
                                <div style="color: #999;">Dur√©e retour</div>
                                <div style="font-weight: 600; color: #333;">${formatDuration(returnFlight.total_duration)}</div>
                            </div>
                        </div>
                        
                        <div class="flight-section">
                            <div class="section-title">üõ¨ Vol Retour</div>
                            ${returnSegmentsHtml}
                            ${returnLayoversHtml}
                        </div>
                    </div>
                `;
            });

            html += '</div></div>';
            results.innerHTML = html;
        }

        function displayResults(data) {
            const results = document.getElementById('results');
            const flights = data.best_flights || [];
            
            if (flights.length === 0) {
                results.innerHTML = '<div class="no-results">Aucun vol trouv√© pour ces crit√®res</div>';
                return;
            }

            const departureAirport = document.getElementById('departure_airport').value.toUpperCase();
            const arrivalAirport = document.getElementById('arrival_airport').value.toUpperCase();
            const departureDate = document.getElementById('departure_date').value;
            const returnDate = document.getElementById('return_date').value;

            results.innerHTML = flights.slice(0, 10).map(flight => {
                const outboundFlights = flight.flights || [];
                let outboundSegments = '';
                let outboundLayovers = '';
                
                outboundFlights.forEach((segment, index) => {
                    outboundSegments += formatFlightSegment(segment);
                    
                    if (index < outboundFlights.length - 1 && flight.layovers && flight.layovers[index]) {
                        const layover = flight.layovers[index];
                        outboundLayovers += `
                            <div style="padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; margin: 10px 0; border-radius: 3px;">
                                <strong>‚è±Ô∏è Escale √† ${layover.name} (${layover.id})</strong><br>
                                <span style="color: #666;">Dur√©e: ${formatDuration(layover.duration)}</span>
                            </div>
                        `;
                    }
                });

                return `
                    <div class="flight-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div 
                                class="price-badge" 
                                onclick="selectOutboundFlight(${JSON.stringify(flight).replace(/"/g, '&quot;')}, '${departureAirport}', '${arrivalAirport}', '${returnDate}', '${departureDate}')"
                                style="cursor: pointer; transition: transform 0.2s;"
                                onmouseover="this.style.transform = 'scale(1.05)'"
                                onmouseout="this.style.transform = 'scale(1)'"
                            >
                                ${flight.price} EUR
                            </div>
                            <div style="text-align: right; font-size: 13px;">
                                <div style="color: #999;">Dur√©e totale</div>
                                <div style="font-weight: 600; color: #333;">${formatDuration(flight.total_duration)}</div>
                            </div>
                        </div>
                        
                        <div class="flight-section">
                            <div class="section-title">üõ´ Vol Aller</div>
                            ${outboundSegments}
                            ${outboundLayovers}
                        </div>
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>